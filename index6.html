<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Συναλλαγές Προμηθευτών</title>
    <style>
        /* Styling για τη modal και τα υπόλοιπα στοιχεία */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <h2>Προμηθευτές</h2>
    <div id="supplier-list">
        <!-- Λίστα προμηθευτών θα προστεθεί δυναμικά εδώ -->
    </div>

    <!-- Modal για συναλλαγές -->
    <div id="transaction-modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Συναλλαγές Προμηθευτή</h3>
            <table id="transaction-table">
                <thead>
                    <tr>
                        <th>Ημερομηνία</th>
                        <th>Ποσό</th>
                        <th>Κατηγορία</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Οι συναλλαγές θα προστεθούν εδώ -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
    <script>
        // Firebase configuration (πρέπει να προσθέσεις τα σωστά δεδομένα)
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_AUTH_DOMAIN",
            databaseURL: "YOUR_DATABASE_URL",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_STORAGE_BUCKET",
            messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // Αναφορές στον πίνακα των προμηθευτών
        const suppliersRef = ref(database, 'suppliers');
        const transactionsRef = ref(database, 'transactions');
        const paymentsRef = ref(database, 'bank-payments');
        const invoicesRef = ref(database, 'credit-invoices');

        const modal = document.getElementById("transaction-modal");
        const span = document.getElementsByClassName("close")[0];

        // Αρχικοποίηση λίστας προμηθευτών
        function loadSuppliers() {
            const supplierList = document.getElementById('supplier-list');
            onValue(suppliersRef, snapshot => {
                const data = snapshot.val();
                supplierList.innerHTML = ''; // Καθαρισμός προηγούμενης λίστας
                for (const supplierName in data) {
                    const supplierItem = document.createElement('div');
                    supplierItem.innerHTML = `
                        <h3>${supplierName}</h3>
                        <div><strong>Συνολικό Άθροισμα:</strong> €0</div>
                        <button onclick="openTransactionModal('${supplierName}')">Προβολή Συναλλαγών</button>
                    `;
                    supplierList.appendChild(supplierItem);

                    // Υπολογισμός και εμφάνιση του συνολικού ποσού για κάθε προμηθευτή
                    let totalAmount = 0;
                    let cashPaymentTotal = 0;
                    let bankPaymentTotal = 0;
                    let invoiceTotal = 0;

                    // Fetch Transactions
                    onValue(transactionsRef, snapshot => {
                        const data = snapshot.val();
                        for (const date in data) {
                            for (const transactionId in data[date]) {
                                if (data[date][transactionId].supplier === supplierName) {
                                    totalAmount += parseFloat(data[date][transactionId].amount);
                                }
                            }
                        }
                    });

                    // Fetch Invoices
                    onValue(invoicesRef, snapshot => {
                        const data = snapshot.val();
                        for (const date in data) {
                            for (const invoiceId in data[date]) {
                                if (data[date][invoiceId].supplier === supplierName) {
                                    invoiceTotal += parseFloat(data[date][invoiceId].amount);
                                }
                            }
                        }
                    });

                    // Fetch Payments
                    onValue(paymentsRef, snapshot => {
                        const data = snapshot.val();
                        for (const date in data) {
                            for (const paymentId in data[date]) {
                                if (data[date][paymentId].supplier === supplierName) {
                                    if (data[date][paymentId].paymentMethod === 'cash') {
                                        cashPaymentTotal += parseFloat(data[date][paymentId].amount);
                                    } else if (data[date][paymentId].paymentMethod === 'bank') {
                                        bankPaymentTotal += parseFloat(data[date][paymentId].amount);
                                    }
                                }
                            }
                        }
                    });

                    // Update the total amounts
                    supplierItem.querySelector('div:nth-child(2)').innerHTML = `
                        <strong>Συνολικό Άθροισμα:</strong> €${totalAmount + invoiceTotal}
                        <br><strong>Πληρωμή Με Μετρητά:</strong> €${cashPaymentTotal}
                        <br><strong>Πληρωμή Τραπεζικής Κατάθεσης:</strong> €${bankPaymentTotal}
                    `;
                }
            });
        }

        // Ανοίγουμε το Modal με τις συναλλαγές του προμηθευτή
        function openTransactionModal(supplierName) {
            modal.style.display = "block";
            const tableBody = document.querySelector('#transaction-table tbody');
            tableBody.innerHTML = ''; // Καθαρισμός προηγούμενων δεδομένων

            let allTransactions = [];

            // Λήψη συναλλαγών
            onValue(transactionsRef, snapshot => {
                const data = snapshot.val();
                for (const date in data) {
                    for (const transactionId in data[date]) {
                        if (data[date][transactionId].supplier === supplierName) {
                            allTransactions.push({
                                date: data[date][transactionId].date,
                                amount: data[date][transactionId].amount,
                                type: 'Συναλλαγή'
                            });
                        }
                    }
                }
            });

            // Λήψη τιμολογίων
            onValue(invoicesRef, snapshot => {
                const data = snapshot.val();
                for (const date in data) {
                    for (const invoiceId in data[date]) {
                        if (data[date][invoiceId].supplier === supplierName) {
                            allTransactions.push({
                                date: data[date][invoiceId].date,
                                amount: data[date][invoiceId].amount,
                                type: 'Τιμολόγιο'
                            });
                        }
                    }
                }
            });

            // Λήψη πληρωμών
            onValue(paymentsRef, snapshot => {
                const data = snapshot.val();
                for (const date in data) {
                    for (const paymentId in data[date]) {
                        if (data[date][paymentId].supplier === supplierName) {
                            allTransactions.push({
                                date: data[date][paymentId].date,
                                amount: data[date][paymentId].amount,
                                type: data[date][paymentId].paymentMethod === 'cash' ? 'Πληρωμή Με Μετρητά' : 'Πληρωμή Τραπεζικής Κατάθεσης'
                            });
                        }
                    }
                }
                // Ταξινόμηση και εμφάνιση συναλλαγών
                allTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));

                allTransactions.forEach(transaction => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${transaction.date}</td><td>€${transaction.amount}</td><td>${transaction.type}</td>`;
                    tableBody.appendChild(row);
                });
            });
        }

        // Κλείσιμο modal
        span.onclick = function() {
            modal.style.display = "none";
        }
        window.onclick = function(event) {
            if (event.target === modal) {
                modal.style.display = "none";
            }
        }

        // Φόρτωση προμηθευτών
        loadSuppliers();
    </script>
</body>
</html>
