<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Διαχείριση Προμηθευτών</title>
    <style>
        /* Στυλ για το Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.4);
            padding-top: 60px;
        }
        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 10px;
            text-align: center;
        }
    </style>
</head>
<body>
    <div id="suppliers-list">
        <!-- Η λίστα των προμηθευτών θα προστεθεί εδώ -->
    </div>

    <div id="modal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Συναλλαγές για Προμηθευτή</h2>
            <p id="total-summary"></p>
            <table id="transaction-table">
                <thead>
                    <tr>
                        <th>Ημερομηνία</th>
                        <th>Ποσό</th>
                        <th>Τύπος</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Συναλλαγές θα προστεθούν εδώ -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const database = firebase.database();
        const suppliersRef = database.ref('suppliers');
        const modal = document.getElementById('modal');
        const span = document.getElementsByClassName('close')[0];

        // Φορτώνουμε τους προμηθευτές
        function loadSuppliers() {
            const suppliersList = document.getElementById('suppliers-list');
            onValue(suppliersRef, snapshot => {
                const suppliers = snapshot.val();
                suppliersList.innerHTML = ''; // Καθαρίζουμε τη λίστα πριν την ανανέωση
                for (const supplierId in suppliers) {
                    const supplierName = suppliers[supplierId].name;
                    const supplierItem = document.createElement('div');
                    supplierItem.innerHTML = `<h3>${supplierName}</h3><div>Σύνολο: €0</div>`;
                    suppliersList.appendChild(supplierItem);

                    // Κάνουμε κλικ στο όνομα του προμηθευτή για να ανοίξουμε το modal
                    supplierItem.addEventListener('click', () => openTransactionModal(supplierName, supplierItem));
                }
            });
        }

        // Ανοίγουμε το Modal και υπολογίζουμε τα συνολικά ποσά για τον προμηθευτή
        function openTransactionModal(supplierName, supplierItem) {
            modal.style.display = "block";
            const tableBody = document.querySelector('#transaction-table tbody');
            tableBody.innerHTML = ''; // Καθαρίζουμε τα προηγούμενα δεδομένα
            const totalSummary = document.getElementById('total-summary');
            let totalTransactions = 0;
            let totalCashPayments = 0;
            let totalBankPayments = 0;

            const transactionsRef = ref(database, 'transactions');
            const paymentsRef = ref(database, 'bank-payments');
            const invoicesRef = ref(database, 'credit-invoices');

            // Συλλέγουμε όλες τις συναλλαγές, πληρωμές και τιμολόγια για τον προμηθευτή
            let allTransactions = [];

            // Fetch Transactions
            onValue(transactionsRef, snapshot => {
                const data = snapshot.val();
                for (const date in data) {
                    for (const transactionId in data[date]) {
                        if (data[date][transactionId].supplier === supplierName) {
                            const amount = parseFloat(data[date][transactionId].amount);
                            totalTransactions += amount;
                            allTransactions.push({ date: data[date][transactionId].date, amount, type: 'Συναλλαγή' });
                        }
                    }
                }
            });

            // Fetch Payments
            onValue(paymentsRef, snapshot => {
                const data = snapshot.val();
                for (const date in data) {
                    for (const paymentId in data[date]) {
                        if (data[date][paymentId].supplier === supplierName) {
                            const amount = parseFloat(data[date][paymentId].amount);
                            if (data[date][paymentId].type === 'cash') {
                                totalCashPayments += amount;
                            } else if (data[date][paymentId].type === 'bank') {
                                totalBankPayments += amount;
                            }
                            allTransactions.push({ date: data[date][paymentId].date, amount, type: 'Πληρωμή' });
                        }
                    }
                }
            });

            // Fetch Invoices
            onValue(invoicesRef, snapshot => {
                const data = snapshot.val();
                for (const date in data) {
                    for (const invoiceId in data[date]) {
                        if (data[date][invoiceId].supplier === supplierName) {
                            const amount = parseFloat(data[date][invoiceId].amount);
                            totalTransactions += amount;
                            allTransactions.push({ date: data[date][invoiceId].date, amount, type: 'Τιμολόγιο' });
                        }
                    }
                }

                // Ταξινομούμε τις συναλλαγές με βάση την ημερομηνία
                allTransactions.sort((a, b) => new Date(a.date) - new Date(b.date));

                // Εμφανίζουμε τις συναλλαγές στον πίνακα
                allTransactions.forEach(transaction => {
                    const row = document.createElement('tr');
                    row.innerHTML = `<td>${transaction.date}</td><td>€${transaction.amount}</td><td>${transaction.type}</td>`;
                    tableBody.appendChild(row);
                });

                // Ενημερώνουμε τα συνολικά ποσά στο modal
                totalSummary.innerHTML = `
                    <strong>Σύνολο Συναλλαγών: €${totalTransactions}</strong><br>
                    <strong>Πληρωμή με Μετρητά: €${totalCashPayments}</strong><br>
                    <strong>Πληρωμή Τραπεζιού: €${totalBankPayments}</strong>
                `;

                // Ενημερώνουμε το συνολικό ποσό στην καρτέλα του προμηθευτή
                supplierItem.querySelector('div:nth-child(2)').innerHTML = `<strong>Συνολικό Άθροισμα:</strong> €${totalTransactions}`;
            });
        }

        // Κλείσιμο του Modal
        span.onclick = function() {
            modal.style.display = "none";
        }

        // Εκκίνηση της σελίδας
        loadSuppliers();
    </script>
</body>
</html>
