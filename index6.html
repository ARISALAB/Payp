<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Καταγραφή Συναλλαγών Προμηθευτών</title>
    <style>
        /* Styling for the page and modal */
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 1; 
            left: 0; top: 0; 
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgb(0,0,0); 
            background-color: rgba(0,0,0,0.4); 
            padding-top: 60px; 
        }
        .modal-content { 
            background-color: #fefefe; 
            margin: 5% auto; 
            padding: 20px; 
            border: 1px solid #888; 
            width: 80%; 
        }
        .close { 
            color: #aaa; 
            float: right; 
            font-size: 28px; 
            font-weight: bold; 
        }
        .close:hover,
        .close:focus { 
            color: black; 
            text-decoration: none; 
            cursor: pointer; 
        }
    </style>
</head>
<body>
    <h1>Καταγραφή Συναλλαγών Προμηθευτών</h1>

    <!-- Supplier list -->
    <div id="supplier-list"></div>

    <!-- The Modal for displaying transactions -->
    <div id="transactionModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Συναλλαγές για τον Προμηθευτή</h2>
            <table id="transaction-table">
                <thead>
                    <tr>
                        <th>Ημερομηνία</th>
                        <th>Ποσό</th>
                        <th>Τύπος</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Transactions will be added here -->
                </tbody>
            </table>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.2/firebase-database.js"></script>
    <script>
        // Initialize Firebase
        const firebaseConfig = {
         apiKey: "AIzaSyAlFCOK49HAzisru-KTTF0ZqP_mtmEyt6Y",
  authDomain: "speedy-bazaar-411110.firebaseapp.com",
  databaseURL: "https://speedy-bazaar-411110-default-rtdb.firebaseio.com",
  projectId: "speedy-bazaar-411110",
  storageBucket: "speedy-bazaar-411110.appspot.com",
  messagingSenderId: "752456596300",
  appId: "1:752456596300:web:f920df7be01ba63d66ede9",
  measurementId: "G-NGZHWDY6S5"
};
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database(app);

        // Fetch suppliers from the database
        function loadSuppliers() {
            const suppliersRef = firebase.database().ref('suppliers');
            const supplierList = document.getElementById('supplier-list');
            supplierList.innerHTML = '';

            suppliersRef.on('value', (snapshot) => {
                const suppliers = snapshot.val();
                if (suppliers) {
                    Object.keys(suppliers).forEach(supplierName => {
                        const supplierItem = document.createElement('div');
                        supplierItem.innerHTML = `
                            <h3>${supplierName}</h3>
                            <div>
                                <strong>Συνολικό Άθροισμα Συναλλαγών:</strong> €0
                                <br>
                                <strong>Πληρωμή Με Μετρητά:</strong> €0
                                <br>
                                <strong>Πληρωμή Τραπέζης:</strong> €0
                            </div>
                            <button onclick="openTransactionModal('${supplierName}')">Δες Συναλλαγές</button>
                        `;
                        supplierList.appendChild(supplierItem);

                        // Initialize total calculations for the supplier
                        calculateSupplierTotal(supplierItem, supplierName);
                    });
                }
            });
        }

        // Function to calculate the total amounts for the supplier
        function calculateSupplierTotal(supplierItem, supplierName) {
            const transactionsRef = firebase.database().ref('transactions');
            const paymentsRef = firebase.database().ref('bank-payments');
            const invoicesRef = firebase.database().ref('credit-invoices');

            let totalTransactions = 0;
            let cashPayments = 0;
            let bankPayments = 0;

            // Fetch Transactions
            transactionsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                for (const date in data) {
                    for (const transactionId in data[date]) {
                        if (data[date][transactionId].supplier === supplierName) {
                            totalTransactions += parseFloat(data[date][transactionId].amount);
                        }
                    }
                }
            });

            // Fetch Payments (Cash)
            paymentsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                for (const date in data) {
                    for (const paymentId in data[date]) {
                        if (data[date][paymentId].supplier === supplierName) {
                            if (data[date][paymentId].paymentMethod === 'Cash') {
                                cashPayments += parseFloat(data[date][paymentId].amount);
                            } else if (data[date][paymentId].paymentMethod === 'Bank') {
                                bankPayments += parseFloat(data[date][paymentId].amount);
                            }
                        }
                    }
                }
            });

            // Fetch Invoices
            invoicesRef.on('value', (snapshot) => {
                const data = snapshot.val();
                for (const date in data) {
                    for (const invoiceId in data[date]) {
                        if (data[date][invoiceId].supplier === supplierName) {
                            totalTransactions += parseFloat(data[date][invoiceId].amount);
                        }
                    }
                }
                // Update supplier totals
                supplierItem.querySelector('div').innerHTML = `
                    <strong>Συνολικό Άθροισμα Συναλλαγών:</strong> €${totalTransactions}
                    <br>
                    <strong>Πληρωμή Με Μετρητά:</strong> €${cashPayments}
                    <br>
                    <strong>Πληρωμή Τραπέζης:</strong> €${bankPayments}
                `;
            });
        }

        // Function to open the transaction modal
        function openTransactionModal(supplierName) {
            const modal = document.getElementById("transactionModal");
            const tableBody = document.querySelector('#transaction-table tbody');
            tableBody.innerHTML = ''; // Clear previous data

            const transactionsRef = firebase.database().ref('transactions');
            const paymentsRef = firebase.database().ref('bank-payments');
            const invoicesRef = firebase.database().ref('credit-invoices');

            let allTransactions = [];

            // Fetch and display all transactions, payments, and invoices for the supplier
            transactionsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                for (const date in data) {
                    for (const transactionId in data[date]) {
                        if (data[date][transactionId].supplier === supplierName) {
                            allTransactions.push({
                                date: data[date][transactionId].date,
                                amount: data[date][transactionId].amount,
                                type: 'Συναλλαγή'
                            });
                        }
                    }
                }
            });

            paymentsRef.on('value', (snapshot) => {
                const data = snapshot.val();
                for (const date in data) {
                    for (const paymentId in data[date]) {
                        if (data[date][paymentId].supplier === supplierName) {
                            allTransactions.push({
                                date: data[date][paymentId].date,
                                amount: data[date][paymentId].amount,
                                type: data[date][paymentId].paymentMethod === 'Cash' ? 'Πληρωμή Με Μετρητά' : 'Πληρωμή Τραπέζης'
                            });
                        }
                    }
                }
            });

            invoicesRef.on('value', (snapshot) => {
                const data = snapshot.val();
                for (const date in data) {
                    for (const invoiceId in data[date]) {
                        if (data[date][invoiceId].supplier === supplierName) {
                            allTransactions.push({
                                date: data[date][invoiceId].date,
                                amount: data[date][invoiceId].amount,
                                type: 'Τιμολόγιο'
                            });
                        }
                    }
                }
                // Sort and display transactions
                allTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                allTransactions.forEach(transaction => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${transaction.date}</td>
                        <td>€${transaction.amount}</td>
                        <td>${transaction.type}</td>
                    `;
                    tableBody.appendChild(row);
                });
            });

            modal.style.display = "block";
        }

        // Function to close the modal
        document.querySelector('.close').onclick = function() {
            document.getElementById("transactionModal").style.display = "none";
        }

        // Initialize the supplier list
        loadSuppliers();
    </script>
</body>
</html>
